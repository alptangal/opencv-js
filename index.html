<!DOCTYPE html>
<html>
<body>
  <img style="display:none;" id="img" crossorigin="anonymous" src="https://raw.githubusercontent.com/undecaf/zbar-wasm/master/tests/img/qr_code.png">
  <video playsinline autoplay></video>
  <pre id="result1"></pre>
  <pre id="result"></pre>
  <script src="https://cdn.jsdelivr.net/npm/@undecaf/zbar-wasm@0.11.0/dist/index.js"></script>
  <script type="module">
import { BarcodeDetectorPolyfill } from "https://cdn.jsdelivr.net/npm/@undecaf/barcode-detector-polyfill@latest/dist/main.js";
let detector=null
let requestId=null
let video= document.querySelector("video");
      const constraints={
        audio:false,
        video:{
          width:1500,
          height:1500,
    facingMode: { exact: "environment" }
  },
      }
async function createDetector() {
    supportedFormats = await BarcodeDetectorPolyfill.getSupportedFormats()
    detector = new BarcodeDetectorPolyfill({ formats: supportedFormats, zbar: { encoding: 'utf-8' } })
}
function detectVideo(repeat) {
    if (!repeat) {
        ctx.clearRect(0, 0, canvas.width, canvas.height)
    }

    if (typeof repeat === 'undefined') {
        repeat = true
    }

    if (repeat) {
      detector.detect(video).then(symbols=>{
          result1.innerText=JSON.stringify(symbols)
        })

    } else {
        cancelAnimationFrame(requestId)
        requestId = null
    }
}

createDetector()
    (async () => {
      const
        img = document.getElementById('img'),
        result = document.getElementById('result'),
        result1 = document.getElementById('result1'),
        canvas = document.createElement('canvas'),
        context = canvas.getContext('2d');

      await img.decode()
      canvas.width = img.naturalWidth
      canvas.height = img.naturalHeight
      context.drawImage(img, 0, 0)

      const
        imageData = context.getImageData(0, 0, canvas.width, canvas.height),
        symbols = await zbarWasm.scanImageData(imageData);
      
      symbols.forEach(s => s.rawData = s.decode())
      result.innerText = JSON.stringify(symbols, null, 2)
      
      await navigator.mediaDevices.getUserMedia(constraints).then(stream=>{
        video.srcObject=stream
        video.play()
        detectVideo()
      })
      
    })()
  </script>
</body>
</html>